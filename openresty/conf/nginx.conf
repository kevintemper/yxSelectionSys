worker_processes  auto;

events { worker_connections  1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;

  # 访问日志里记录最终命中的环境，方便排查
  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" env=$target_env';
  access_log  /var/log/nginx/access.log  main;

  # ======================= 上游网关 / 服务 =======================
  upstream yx_gateway_gray { server host.docker.internal:9301; }  # gray 网关实例
  upstream yx_gateway_prd  { server host.docker.internal:9300; }  # prd 网关实例

  # 如果需要直连微服务，可在这里定义 yx_auth_gray/prd、yx_store_gray/prd

  # ======================= 灰度判定逻辑 =======================
  map $http_x_env $header_env {
    default "";
    "~*gray" gray;
    "~*prd"  prd;
  }

  map $cookie_env $cookie_env_flag {
    default "";
    "~*gray" gray;
    "~*prd"  prd;
  }

  map $http_x_user_id $user_based_env {
    default "";
    "~*gray$" gray;   # 用户 ID 以 gray 结尾时强制命中灰度
  }

  split_clients "${remote_addr}${request_uri}" $percent_env {
    5%     gray;       # 5% 流量走灰度做金丝雀
    *      prd;
  }

  # 任何显式指定（Header/Cookie/UserId）优先，其余走百分比
  map "$header_env$cookie_env_flag$user_based_env" $explicit_env {
    default "";
    "~*gray" gray;
    "~*prd"  prd;
  }

  map $explicit_env $target_env {
    default $percent_env;
    ""      $percent_env;
    gray     gray;
    prd      prd;
  }

  map $target_env $gateway_upstream {
    default yx_gateway_prd;
    gray    yx_gateway_gray;
    prd     yx_gateway_prd;
  }

  map $target_env $static_root {
    default /usr/local/openresty/sites/prd;
    gray    /usr/local/openresty/sites/gray;
    prd     /usr/local/openresty/sites/prd;
  }

  server {
    listen       80;
    server_name  localhost;

    set $yx_env $target_env;

    # ---------- 外部访问（南北向）：静态资源 + 接口 ----------
    location ^~ /api/ {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Env             $yx_env;
      proxy_set_header X-Gray            $yx_env;
      proxy_set_header SERVICE-TAG       $yx_env;
      proxy_pass http://$gateway_upstream;
    }

    # ---------- 内部访问（东西向）：集团内部系统通过 kaiwen-proxy ----------
    location ^~ /kaiwen-proxy/ {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Env             $yx_env;
      proxy_set_header X-Gray            $yx_env;
      proxy_set_header SERVICE-TAG       $yx_env;
      proxy_pass http://$gateway_upstream;
    }

    # ---------- 静态资源按环境指向各自目录 ----------
    location / {
      root   $static_root;
      try_files $uri $uri/ /index.html;
    }
  }
}
